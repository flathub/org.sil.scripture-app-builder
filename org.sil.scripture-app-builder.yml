# REFERENCES:
# Python2.7:  https://github.com/flathub/shared-modules/blob/cc50bdbb34cc3d29bf61cfea5e27cd980b7bda04/python2.7/python-2.7.json
# OpenJDK17: https://github.com/flathub/org.freedesktop.Sdk.Extension.openjdk17/blob/branch/23.08/org.freedesktop.Sdk.Extension.openjdk17.yaml
# Node20:    https://github.com/flathub/org.freedesktop.Sdk.Extension.node20/blob/branch/23.08/org.freedesktop.Sdk.Extension.node20.yaml
app-id: org.sil.scripture-app-builder
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
  - org.freedesktop.Sdk.Extension.node22
finish-args:
  # Window x11 socket access
  - --socket=x11
  # Audio access
  - --socket=pulseaudio
  # Network access
  - --share=network
  # XShm access
  - --share=ipc
  # All external devices (catch all for devices we interact with and graphical acceleration)
  - --device=all
  # Local file browsing access
  - --filesystem=host
  # USB Drives
  - --system-talk-name=org.freedesktop.Udisks2
  # File saving access
  - --talk-name=org.freedesktop.FileManager1

# App's run command
command: sab-run.sh

modules:
  - name: xterm
    sources:
      - type: git
        url: https://github.com/ThomasDickey/xterm-snapshots.git
        tag: xterm-403
        commit: 1b8146571535adeee117fc4db331a4b44eda74a9
        x-checker-data:
          type: anitya
          project-id: 5272
          tag-template: xterm-$version
          is-main-source: true
    modules:
      # Added xmu for x-term
      - name: libxmu
        buildsystem: autotools
        cleanup:
          - /include
          - '*.a'
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/xorg/lib/libxmu.git
            commit: cc378e4f0cc2ab5b66d378050ba4956612a01197
      - name: libXaw
        sources:
          - type: archive
            url: https://www.x.org/archive/individual/lib/libXaw-1.0.16.tar.xz
            sha256: 731d572b54c708f81e197a6afa8016918e2e06dfd3025e066ca642a5b8c39c8f
      - name: ncurses
        config-opts:
          - --without-cxx
          - --without-cxx-binding
        sources:
          - type: archive
            url: https://invisible-mirror.net/archives/ncurses/ncurses-6.4.tar.gz
            sha256: 6931283d9ac87c5073f30b6290c4c75f21632bb4fc3603ac8100812bed248159

  - name: python3-aeneas
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" "setuptools" "pyproject-metadata"
        "meson-python"
      - pip3 install --no-index --find-links="file://${PWD}" "numpy"
      - pip3 install --no-index --find-links="file://${PWD}" "beautifulsoup4" "lxml"
        "soupsieve"
      - pip3 install --verbose --no-index --find-links="file://${PWD}" "aeneas" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/a3/dc/17031897dae0efacfea57dfd3a82fdd2a2aeb58e0ff71b77b87e44edc772/setuptools-80.9.0-py3-none-any.whl
        sha256: 062d34222ad13e0cc312a4c02d73f059e86a4acbfbdea8f8f76b28c99f306922
      - type: file
        url: https://files.pythonhosted.org/packages/91/c0/104cb6244c83fe6bc3886f144cc433db0c0c78efac5dc00e409a5a08c87d/meson_python-0.16.0-py3-none-any.whl
        sha256: 842dc9f5dc29e55fc769ff1b6fe328412fe6c870220fc321060a1d2d395e69e8
      - type: file
        url: https://files.pythonhosted.org/packages/c4/cb/4678dfd70cd2f2d8969e571cdc1bb1e9293c698f8d1cf428fadcf48d6e9f/pyproject_metadata-0.7.1-py3-none-any.whl
        sha256: 28691fbb36266a819ec56c9fa1ecaf36f879d6944dfde5411e87fc4ff793aa60
      - type: file
        url: https://files.pythonhosted.org/packages/e5/92/88d421001bb257588df4864ceca24d570e2e822db4f40f48737a78b648b2/aeneas-1.7.3.0.tar.gz
        sha256: b492d8ba36f12cce69c29c35e7075857a9d036c4743cc8f4689922be980826da
      - type: file
        url: https://files.pythonhosted.org/packages/d1/c2/fe97d779f3ef3b15f05c94a2f1e3d21732574ed441687474db9d342a7315/soupsieve-2.6-py3-none-any.whl
        sha256: e72c4ff06e4fb6e4b5a9f0f55fe6e81514581fca1515028625d0f299c602ccc9
      - type: file
        url: https://files.pythonhosted.org/packages/e7/6b/20c3a4b24751377aaa6307eb230b66701024012c29dd374999cc92983269/lxml-5.3.0.tar.gz
        sha256: 4e109ca30d1edec1ac60cdbe341905dc3b8f55b16855e03a54aaf59e51ec8c6f
      - type: file
        url: https://files.pythonhosted.org/packages/65/6e/09db70a523a96d25e115e71cc56a6f9031e7b8cd166c1ac8438307c14058/numpy-1.26.4.tar.gz
        sha256: 2a02aba9ed12e4ac4eb3ea9421c420301a0c6460d9830d74a9df87efa4912010
      - type: file
        url: https://files.pythonhosted.org/packages/b1/fe/e8c672695b37eecc5cbf43e1d0638d88d66ba3a44c4d321c796f4e59167f/beautifulsoup4-4.12.3-py3-none-any.whl
        sha256: b80878c9f40111313e55da8ba20bdba06d8fa3969fc68304167741bbf9e082ed
    modules:
      - name: espeak
        no-autogen: true
        subdir: src
        cleanup:
          - '*.a'
        sources:
          - type: git
            url: https://salsa.debian.org/a11y-team/espeak.git
            commit: 0dd86a59e84a475bdd809a3aec7bc95a460ad5a6
          - type: patch
            path: patches/espeak/FlatpakEspeak.patch

  - name: openjdk17
    buildsystem: simple
    build-commands:
      # jre install script from extensions location
      - /usr/lib/sdk/openjdk17/install.sh
      # jdk
      - /usr/lib/sdk/openjdk17/installjdk.sh
      # symlink with version number so App Builder can find JDK version
      # similar to how version is in folder name when installed to /usr/lib/jvm
      - ln -s /app/jdk "/app/jdk$(awk -F\" '/JAVA_VERSION=/ {print $2}' /app/jdk/release)"

  - name: openjfx
    buildsystem: simple
    build-commands:
      - mkdir /app/lib/openjfx
      - unzip -q -j -d /app/lib/openjfx openjfx.zip '*lib/*'
    sources:
      - type: file
        only-arches:
          - x86_64
        dest-filename: openjfx.zip
        url: https://download2.gluonhq.com/openjfx/17.0.11/openjfx-17.0.11_linux-x64_bin-sdk.zip
        sha256: f46a1fbea32b83cca6715d74cba7d9c24ce320f1da2daf8ff852f133e9f15674

  - name: scripture-app-builder
    buildsystem: simple
    build-commands:
      # Prebuilt binaries tarball from build in the private repo
      # The source has to be private due to agreements with copyright holders of content being included by end users
      - mkdir /app/scripture-app-builder
      - tar xf scripture-app-builder.tgz -C /app/scripture-app-builder
      # Icons, desktop entry, metainfo and runner script
      - install -Dm644 /app/scripture-app-builder/app-icons/scripture-app-builder.png
        /app/share/icons/hicolor/128x128/apps/org.sil.scripture-app-builder.png
      - install -Dm644 /app/scripture-app-builder/app-icons/scripture-app-builder.svg
        /app/share/icons/hicolor/scalable/apps/org.sil.scripture-app-builder.svg
      - desktop-file-install --dir /app/share/applications /app/scripture-app-builder/flatpak/org.sil.scripture-app-builder.desktop
      - install -Dm644 /app/scripture-app-builder/flatpak/org.sil.scripture-app-builder.metainfo.xml
        -t /app/share/metainfo/
      - install -Dm755 sab-run.sh /app/bin/sab-run.sh
      # Node
      - /usr/lib/sdk/node22/install-sdk.sh
      - ln -s /app/node /app/scripture-app-builder/tools/node
    cleanup:
      - /scripture-app-builder/app-icons
      - /scripture-app-builder/flatpak
      - /scripture-app-builder/*.sh
    sources:
      - type: script
        dest-filename: sab-run.sh
        commands:
          - exec /app/jre/bin/java -Djava.io.tmpdir="/var/tmp" --module-path "/app/lib/openjfx"
            --add-modules javafx.web,javafx.fxml,javafx.swing,javafx.media --add-opens=javafx.fxml/javafx.fxml=ALL-UNNAMED
            -jar /app/scripture-app-builder/bin/scripture-app-builder.jar "$@"
      # App Builder prebuilt binaries (update branch/build_number and sha256 before each release)
      - type: file
        only-arches:
          - x86_64
        url: https://sil-app-builders-linux-artifacts.s3.amazonaws.com/refs/tags/v13.3.2/111/scripture-app-builder.tgz
        sha256: d96ab8d4f7add433c45f501860df6ef76df16d62ff7f34b56ab7c38826c581d9
